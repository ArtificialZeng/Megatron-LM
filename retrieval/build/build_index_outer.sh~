#!/bin/bash

#SBATCH -p batch_dgx2h_m2 --gres=gpu:16 -A gpu_adlr_nlp -t 8:00:00 --exclusive --nv-meta=ml-model:language-modeling --job-name=adlr-nlp-dev:retrieval

# xxxxxxxxxxxxSBATCH -p batch_dgx2h_m2 -A gpu_adlr_nlp -t 0:20:00 --nodes=1 --exclusive --mem=0 --overcommit --ntasks-per-node=16 --nv-meta=ml-model:language-modeling --job-name=adlr-nlp-dev:retrieval

# cpu_m2
# batch_dgx2h_m2
# --dependency=singleton

NAME="lmcafee-retrieval"

# DIR=$(readlink -f `pwd`)
DIR=`pwd`
DATETIME=`date +'date_%y-%m-%d_time_%H-%M-%S'`
LOG_DIR=$DIR/logs/build
mkdir -p $LOG_DIR

# >>>
task=train
# task=add
# task=query

# ntrain=10000
# ntrain=100000
# ntrain=200000
ntrain=100000000

# ncluster=4096
# ncluster=8192
# ncluster=16384
# ncluster=262144
ncluster=4194304

# index_ty=fancy # simple
# index_str="Flat"
# index_str="IVF${ncluster}_HNSW32,Flat"
# index_str="OPQ64_64,IVF${ncluster}_HNSW32,PQ64"
# index_str="OPQ64_128,IVF${ncluster}_HNSW32,PQ64" # boxin base
# index_str="OPQ64_256,IVF${ncluster}_HNSW32,PQ64"
# index_str="OPQ64_512,IVF${ncluster}_HNSW32,PQ64"
# index_str="OPQ32_64,IVF${ncluster}_HNSW32,PQ32"
# index_str="OPQ32_128,IVF${ncluster}_HNSW32,PQ32"
# index_str="OPQ32_256,IVF${ncluster}_HNSW32,PQ32"
# index_str="OPQ32_512,IVF${ncluster}_HNSW32,PQ32"

# index_str="OPQ16_8,IVF${ncluster}_HNSW32,PQ16"
# index_str="OPQ16_16,IVF${ncluster}_HNSW32,PQ16"
# index_str="OPQ16_32,IVF${ncluster}_HNSW32,PQ16"
# index_str="OPQ16_64,IVF${ncluster}_HNSW32,PQ16"
# index_str="OPQ16_128,IVF${ncluster}_HNSW32,PQ16"
# index_str="OPQ16_256,IVF${ncluster}_HNSW32,PQ16"
index_str="OPQ16_512,IVF${ncluster}_HNSW32,PQ16"
# <<<

# run_cmd="bash lawrence/train_index_inner.sh $index_ty $ntrain $ncluster"
# run_cmd="pwd && cd $DIR && pwd && bash lawrence/build_index_inner.sh $task $index_str $ntrain $ncluster"
run_cmd="pwd && cd $DIR && pwd && bash lawrence/build/build_index_inner.sh $task $index_str $ntrain"
# run_cmd="env"
# run_cmd="cd $DIR && pwd"
# run_cmd="pwd"

# --output=$DIR/logs/%x_%j_$DATETIME.log sh -c "${run_cmd}"
# --container-mounts "/lustre/fsw/adlr:/lustre/fsw/adlr" \
# CONTAINER_MOUNTS="/home/lmcafee-src:/home/lmcafee-src,/gpfs/fs1/projects/gpu_adlr/datasets/lmcafee:/gpfs/fs1/projects/gpu_adlr/datasets/lmcafee"
CONTAINER_MOUNTS="/home/lmcafee/src:/home/lmcafee/src,/gpfs/fs1/projects/gpu_adlr/datasets/lmcafee:/gpfs/fs1/projects/gpu_adlr/datasets/lmcafee"
# CONTAINER_MOUNTS="/gpfs/fs1/projects/gpu_adlr/datasets/lmcafee:/gpfs/fs1/projects/gpu_adlr/datasets/lmcafee"
# CONTAINER_MOUNTS="/gpfs/fs1/projects/gpu_adlr:/gpfs/fs1/projects/gpu_adlr"
# CONTAINER_MOUNTS="/gpfs:/gpfs"
# CONTAINER_MOUNTS="/gpfs/fs1:/gpfs/fs1,/home/lmcafee-src:/home/lmcafee-src"
# --output=$DIR/logs/%j_i${index_ty}_t${ntrain}_c${ncluster}.log sh -c "${run_cmd}"
srun -l \
     --container-image "nvcr.io#nvidia/pytorch:22.04-py3" \
     --container-mounts $CONTAINER_MOUNTS \
     --output=$LOG_DIR/%j__${task}__${index_str}__t${ntrain}.log sh -c "${run_cmd}"

set +x

# eof
